<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETAR Rendszer</title>
    <!-- 
        TODO: Google Site Verification - Replace the content with your actual verification code from Google Search Console.
    -->
    <meta name="google-site-verification" content="gF5FQjM4O_fTECxxNGksEd6k-NRp7SDbew6PXuIBNZY" />
    <link rel="icon" type="image/png" href="ETAR_H-IITB_512.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PizZip, Docxtemplater -->
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.34.2/build/docxtemplater.js"></script>
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Environment Variables -->
    <script src="env.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        .input-field {
            background-color: white; color: black !important; font-weight: bold;
            width: 100%; padding: 0.5rem; border-radius: 0.375rem;
            border: 1px solid #93c5fd; transition: all 0.2s;
        }
        .input-field:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            border-color: #3b82f6; box-shadow: 0 0 0 2px #3b82f6;
        }
        .input-field::placeholder { color: #a0aec0; font-weight: normal; }
        select.input-field:invalid { color: #a0aec0 !important; font-weight: normal; }
        .btn { @apply px-6 py-2 rounded-md font-semibold text-white transition-transform transform hover:scale-105 shadow-lg; }
        .btn:disabled { @apply bg-slate-500 cursor-not-allowed scale-100; }
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700; }
        .btn-secondary { @apply bg-slate-600 hover:bg-slate-700; }
        .btn-success { @apply bg-green-600 hover:bg-green-700; }
        .btn-info { @apply bg-teal-600 hover:bg-teal-700; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700; }
        .card { @apply bg-blue-950/50 p-6 sm:p-8 rounded-xl shadow-2xl border border-blue-800; }
        .loader {
            border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db;
            width: 40px; height: 40px; animation: spin 2s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Modal Stílusok */
        .modal-overlay {
            @apply fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50;
        }
        .modal-content {
            @apply bg-slate-800 text-white p-8 rounded-lg shadow-xl max-w-lg w-full;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-blue-900 text-gray-200 min-h-screen flex items-center justify-center p-4">
    
    <img src="ETAR_H.png" alt="ETAR-H Logó" class="hidden md:block fixed top-4 left-4 w-24 h-24 rounded-full border-2 border-blue-400 shadow-xl z-50 transition-transform hover:scale-110">

    <div class="container mx-auto max-w-5xl">

        <!-- Képernyők -->
        <div id="loginScreen" class="screen active text-center">
             <div class="card max-w-md mx-auto">
                <img src="logo.jpg" alt="ETAR Logó" class="mx-auto mb-8 w-64 h-auto rounded-lg shadow-md" onerror="this.onerror=null; this.src='https://placehold.co/256x100/172554/ffffff?text=ETAR+Logo';">
                <h1 class="text-3xl sm:text-4xl font-bold mb-2">ETAR Rendszer</h1>
                <p class="mb-8 text-blue-300">Kérjük, jelentkezzen be Google fiókjával a használathoz.</p>
                <div id="signInButtonWrapper">
                    <button id="signInButton" class="btn btn-primary text-lg w-full" disabled>Bejelentkezés Google Fiókkal</button>
                </div>
                <div id="loadingStatus" class="mt-6 text-center">
                    <div class="loader mx-auto"></div>
                    <p class="mt-2">Google szolgáltatások betöltése...</p>
                </div>
                <div class="mt-8 text-center text-sm">
                    <a href="https://etar.cloud/privacy.html" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300 hover:underline">Adatvédelmi irányelvek</a>
                </div>
            </div>
        </div>
        <div id="ejkPartnerSelectScreen" class="screen">
            <div class="card max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">Partner Adatbázis Kiválasztása (EJK)</h1>
                    <button id="signOutButtonEjk" class="btn btn-secondary text-sm">Kijelentkezés</button>
                </div>
                <div id="currentPartnerInfo" class="mb-4"></div>
                <p id="ejkUserInfo" class="mb-6 text-blue-300"></p>
                <div id="partnerList" class="space-y-2"></div>
            </div>
        </div>
        <div id="ejkMainScreen" class="screen text-center">
             <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <button id="backToPartnerSelectBtn" class="btn btn-secondary text-sm">Vissza a partnerekhez</button>
                    <h2 id="ejkSelectedPartner" class="text-xl font-bold"></h2>
                    <div class="w-32"></div> <!-- Placeholder for spacing -->
                </div>
                <h1 class="text-3xl sm:text-4xl font-bold mb-6">ETAR Jegyzőkönyv Készítő (EJK)</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 justify-center mb-8">
                    <button id="ejkNewDeviceBtn" class="btn btn-primary text-lg">1. Új eszköz feltöltés</button>
                    <button id="ejkNewInspectionBtn" class="btn btn-primary text-lg">2. Új vizsgálat</button>
                    <button id="ejkGenerateProtocolsBtn" class="btn btn-success text-lg">3. Jegyzőkönyv generálás</button>
                    <button id="ejkDownloadDbBtn" class="btn btn-info text-lg">4. Adatbázis letöltés</button>
                </div>
                <div id="ejkStatus" class="mt-4 text-center"></div>
                <div id="ejkDeviceTable" class="mt-4">
                </div>
            </div>
        </div>
        <div id="enyMainScreen" class="screen"></div>
        <div id="deviceDetailsScreen" class="screen"></div>
        <div id="dataEntryScreen" class="screen"></div>
        <div id="ejkGenerateDocsScreen" class="screen"></div>
        <div id="newInspectionScreen" class="screen"></div>
    </div>
    
    <!-- Megerősítő Modal -->
    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">Mentés Megerősítése</h2>
            <p id="modalMessage" class="mb-6"></p>
            <div id="modalStats" class="mb-6 bg-slate-700 p-4 rounded text-lg space-y-2"></div>
            <div class="flex justify-end gap-4">
                <button id="modalCancelBtn" class="btn btn-secondary">Mégse</button>
                <button id="modalConfirmBtn" class="btn btn-success">Megerősítés</button>
            </div>
        </div>
    </div>
    
    <script>
    // ===================================================================================
    // FONTOS BEÁLLÍTÁSOK
    // ===================================================================================
    const API_KEY = window.ETAR_CONFIG.API_KEY;
    const CLIENT_ID = window.ETAR_CONFIG.CLIENT_ID;
    const ROUTING_TABLE_FOLDER_ID = window.ETAR_CONFIG.ROUTING_TABLE_FOLDER_ID;
    const MAIN_ROOT_FOLDER_ID = window.ETAR_CONFIG.MAIN_ROOT_FOLDER_ID;
    // ===================================================================================

    const SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';

    let userRootFolderId = null; // Dinamikusan fogjuk beállítani
    let gapiInited = false;
    let gisInited = false;
    let tokenClient;
    let gapiClientInitedPromise;
    let userProfile = null;
    
    let currentPartner = {};
    let partnerDatabase = []; 
    let companyData = {};
    let newDeviceData = [];
    let lastDeviceData = {};
    let currentInspectedDevice = null; // Az "Új vizsgálat" képernyőn aktuálisan kiválasztott eszköz
    
    const expertIds = {
        "Nagy Imre": "P94B 146259",
        "Gerőly Iván": "PTG 032946",
        "Szadlon Norbert": "CXBC 539792",
        "Bagyinszki Lóránt": "CXBC 1671430"
    };

    let screens = {};
    
    // --- ÁLTALÁNOS FÜGGVÉNYEK ---
    function showScreen(screenId) {
        Object.values(screens).forEach(screen => screen.classList.remove('active'));
        screens[screenId].classList.add('active');
    }

    function setStatus(elementId, message, isError = false) {
        const el = document.getElementById(elementId);
        if (el) {
            el.innerHTML = message;
            el.className = `mt-6 text-center ${isError ? 'text-red-400' : 'text-blue-300'}`;
        }
    }

    const findValue = (obj, key) => {
        if (!obj || !key) return '';
        const keyToFind = key.toLowerCase().trim();
        const foundKey = Object.keys(obj).find(k => k.toLowerCase().trim() === keyToFind);
        const value = foundKey ? obj[foundKey] : '';
        return value === null || value === undefined ? '' : String(value);
    };

    function readFileAsArrayBuffer(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = e => reject(e);
            reader.readAsArrayBuffer(file);
        });
    }

    // --- GOOGLE API INICIALIZÁLÁS ---
    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    function initializeGapiClient() {
        gapiClientInitedPromise = new Promise(async (resolve, reject) => {
            try {
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest', 'https://people.googleapis.com/$discovery/rest?version=v1'],
                });
                resolve();
            } catch (error) {
                reject(error);
            }
        });
        gapiInited = true;
        checkInitStatus();
    }
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES, callback: '', 
        });
        gisInited = true;
        checkInitStatus();
    }
    function checkInitStatus() {
        if (gapiInited && gisInited) {
            setStatus('loadingStatus', 'A rendszer készen áll a bejelentkezésre.');
            document.getElementById('signInButton').disabled = false;
        }
    }
    
    // --- INICIALIZÁLÁS ÉS ESEMÉNYKEZELŐK ---
    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        screens = {
            login: document.getElementById('loginScreen'),
            ejkSelect: document.getElementById('ejkPartnerSelectScreen'),
            ejkMain: document.getElementById('ejkMainScreen'),
            enyMain: document.getElementById('enyMainScreen'),
            details: document.getElementById('deviceDetailsScreen'),
            dataEntry: document.getElementById('dataEntryScreen'),
            ejkGenerateDocs: document.getElementById('ejkGenerateDocsScreen'),
            newInspection: document.getElementById('newInspectionScreen'),
        };

        // KÖZPONTI ESEMÉNYKEZELŐ (EVENT DELEGATION)
        document.body.addEventListener('click', (event) => {
            const buttonTarget = event.target.closest('button');
            const sortTarget = event.target.closest('[data-sort-key]');

            if (buttonTarget) {
                if (buttonTarget.id === 'signInButton') handleSignIn();
                if (buttonTarget.id === 'signOutButtonEjk' || buttonTarget.id === 'signOutButtonEny') handleSignOut();
                if (buttonTarget.id === 'backToPartnerSelectBtn') showScreen('ejkSelect');
                if (buttonTarget.id === 'backToEjkMainBtn') showScreen('ejkMain'); // EJK: Vissza a főmenübe
                if (buttonTarget.id === 'backToEnyMainBtn') showEnyScreen({ name: currentPartner.name, id: currentPartner.folderId }); // ENY: Vissza az adatbázishoz
                if (buttonTarget.id === 'ejkNewDeviceBtn') showNewDeviceScreen('ejkMain');
                if (buttonTarget.id === 'enyNewDeviceBtn') showNewDeviceScreen('enyMain');
                if (buttonTarget.id === 'ejkNewInspectionBtn') showNewInspectionScreen();
                if (buttonTarget.id === 'ejkDownloadDbBtn') handleDownloadDatabase();
                if (buttonTarget.id === 'ejkGenerateProtocolsBtn') showEjkDocGeneration();
                if (buttonTarget.id === 'addAnotherDeviceBtnEjk') handleAddAnotherDeviceEjk();
                if (buttonTarget.id === 'saveToDriveBtnEjk') showSaveConfirmation();
                if (buttonTarget.id === 'processFilesBtnEjk') handleProcessFilesEjk();
                if (buttonTarget.id === 'generateProtocolsBtnEny') handleGenerateProtocolsEny();
                if (buttonTarget.id === 'deleteSelectedBtnEjk') handleDeleteSelectedEjk();
                if (buttonTarget.id === 'deleteSelectedBtnEny') handleDeleteSelectedEny();
                if (buttonTarget.id === 'downloadDbBtnEny') handleDownloadDatabase();
                if (buttonTarget.id === 'registerNewDeviceFromSearchBtn') {
                    const serialNumber = buttonTarget.dataset.serialNumber; // A visszatérési képernyő itt az 'ejkMain' lesz, ami helyes.
                    showNewDeviceScreen('ejkMain', { eszkoz_gyariszam: serialNumber });
                }
                
                if (buttonTarget.dataset.partnerId) {
                     selectPartner({
                        name: buttonTarget.dataset.partnerName,
                        id: buttonTarget.dataset.partnerId,
                     });
                }

                if (buttonTarget.id === 'searchDeviceBySerialBtn') {
                    event.preventDefault(); // Form submit megelőzése
                    handleSearchDeviceBySerial();
                }

                if (buttonTarget.id === 'finishNewInspectionBtn') {
                    handleFinishNewInspection();
                }
            }
            
            if (sortTarget) {
                if (screens.ejkGenerateDocs.classList.contains('active')) {
                    handleSortDeviceList(sortTarget.dataset.sortKey);
                } else if (screens.ejkMain.classList.contains('active')) {
                    // A főmenü táblázatának rendezése
                    if (sortState.key === sortTarget.dataset.sortKey) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else { sortState.key = sortTarget.dataset.sortKey; sortState.direction = 'asc'; }
                    renderEjkTable();
                } else if (screens.enyMain.classList.contains('active')) {
                    handleSortEnyTable(sortTarget.dataset.sortKey);
                }
            }
        });

        // Eseménykezelő a "Mindent kijelöl" checkboxhoz az ENY felületen
        document.body.addEventListener('change', event => {
            if (event.target.id === 'selectAllCheckboxEny') {
                const isChecked = event.target.checked;
                document.querySelectorAll('#enyDeviceTable input[type="checkbox"]:not(:disabled)').forEach(cb => {
                    cb.checked = isChecked;
                });
            }
        });

        // Eseménykezelő a "Mindent kijelöl" checkboxhoz
        document.body.addEventListener('change', event => {
            if (event.target.id === 'selectAllCheckboxEjk') {
                const isChecked = event.target.checked;
                document.querySelectorAll('#deviceListEjk input[type="checkbox"]').forEach(cb => {
                    cb.checked = isChecked;
                });
            }

            // Eseménykezelő az "Új vizsgálat" képernyő beviteli mezőihez
            const newInspectionInput = event.target.closest('#templateSelectNewInspection, #expertSelectNewInspection, #inspectionLocationInput, #inspectionDateInput, #inspectionTypeNew, #nextInspectionDateNew, #inspectionResultNew');
            if (newInspectionInput) {
                // A "Kész" gomb állapotának frissítése, ha a felső 4 mező bármelyike változik
                if (document.getElementById('newInspectionDataEntry')) {
                    updateNewInspectionFinishButtonState();
                }
            }
        });
    }

    // --- BEJELENTKEZÉSI LOGIKA ---
    function handleSignIn() {
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) {
                setStatus('loadingStatus', `Hiba a bejelentkezés során: ${resp.error}`, true);
                return;
            }
            setStatus('loadingStatus', '<div class="loader mx-auto"></div><p class="mt-2">Bejelentkezés sikeres. Jogosultságok ellenőrzése...</p>');
            
            // Megvárjuk, amíg a GAPI kliens teljesen inicializálódik, és csak utána állítjuk be a tokent.
            await gapiClientInitedPromise;
            gapi.client.setToken(resp);
            await fetchUserProfile();
            if (userProfile) await checkUserRole();
        };
        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
            tokenClient.requestAccessToken({ prompt: '' });
        }
    }

    async function fetchUserProfile() {
        try {
            const response = await gapi.client.people.people.get({
                resourceName: 'people/me', personFields: 'names,emailAddresses',
            });
            const profile = response.result;
            userProfile = {
                name: profile.names?.[0]?.displayName || 'Ismeretlen felhasználó',
                email: profile.emailAddresses?.[0]?.value || 'Nincs e-mail cím'
            };
        } catch (err) {
            const errorDetails = err.result?.error?.message || err.toString();
            setStatus('loadingStatus', `Hiba a felhasználói profil lekérése közben: ${errorDetails}`, true);
            userProfile = null;
        }
    }
    
    // --- SZEREPKÖR-KEZELÉS ---
    async function checkUserRole() {
        if (!userProfile || !userProfile.email) {
            showUnauthorizedUser("Nem sikerült lekérni az e-mail címet a jogosultság ellenőrzéséhez.");
            return;
        }

        setStatus('loadingStatus', '<div class="loader mx-auto"></div><p class="mt-2">Jogosultsági útvonal keresése...</p>');
        const route = await getUserRoute(userProfile.email);

        if (!route) {
            showUnauthorizedUser(`Nincs jogosultság definiálva a(z) ${userProfile.email} címhez.`);
            return;
        }

        userRootFolderId = route.folder_id;

        if (userRootFolderId === MAIN_ROOT_FOLDER_ID) {
            // EJK Felhasználó: Hozzáférése van a fő mappához
            showEjkScreen();
        } else {
            // ENY Felhasználó: Hozzáférése van egy specifikus partnermappához
            showEnyScreen({ id: userRootFolderId, name: route.folder_name || 'Partner Mappa' });
        }
    }

    async function getUserRoute(userEmail) {
        try {
            const response = await gapi.client.drive.files.list({
                q: `'${ROUTING_TABLE_FOLDER_ID}' in parents and name='utvonalak.xlsx' and trashed=false`,
                fields: 'files(id)'
            });
            if (!response.result.files || response.result.files.length === 0) {
                throw new Error("Az 'utvonalak.xlsx' fájl nem található.");
            }
            const fileId = response.result.files[0].id;
            const fileResponse = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
            const workbook = XLSX.read(fileResponse.body, { type: 'binary' });
            const routingData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            return routingData.find(row => findValue(row, 'email').toLowerCase() === userEmail.toLowerCase());
        } catch (err) {
            const errorDetails = err.result?.error?.message || err.message || err.toString();
            setStatus('loadingStatus', `Hiba a jogosultsági tábla olvasása közben: ${errorDetails}`, true);
            return null;
        }
    }

    async function showEjkScreen() {
        showScreen('ejkSelect'); // A partner-választó képernyőre navigálunk
        document.getElementById('ejkUserInfo').textContent = `Bejelentkezve: ${userProfile.name} (${userProfile.email})`;
        setStatus('ejkStatus', '<div class="loader mx-auto"></div><p class="mt-2">Partnermappák betöltése...</p>');
        try {
            const response = await gapi.client.drive.files.list({
                q: `'${userRootFolderId}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
                fields: 'files(id, name)', orderBy: 'name'
            });
            const partners = response.result.files;
            const partnerListDiv = document.getElementById('partnerList');
            partnerListDiv.innerHTML = '';
            if (partners && partners.length > 0) {
                partners.forEach(partner => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-3 rounded-md transition-all font-semibold bg-blue-800 hover:bg-blue-700';
                    button.textContent = partner.name;
                    button.dataset.partnerId = partner.id;
                    button.dataset.partnerName = partner.name;
                    partnerListDiv.appendChild(button);
                });
                setStatus('ejkStatus', 'Válassz egy partnert a listából a folytatáshoz.');
            } else {
                 setStatus('ejkStatus', 'Nem találhatók partnermappák a központi tárolóban.', true);
            }
        } catch(err) {
            const errorMessage = err.result?.error?.message || err.toString();
            setStatus('ejkStatus', `Hiba a partnermappák listázása közben: ${errorMessage}`, true);
        }
    }
    
    async function selectPartner(partner) {
        currentPartner = { name: partner.name, folderId: partner.id };
        showScreen('ejkMain');
        document.getElementById('ejkSelectedPartner').textContent = partner.name;
        setStatus('ejkStatus', `<div class="loader mx-auto"></div><p class="mt-2">'${partner.name}' adatainak betöltése...</p>`);
        const dbLoaded = await loadDatabase(partner.id, 'ejkStatus');
        const companyDataLoaded = await loadCompanyData(partner.id, 'ejkStatus');
        if (dbLoaded && companyDataLoaded) {
            setStatus('ejkStatus', `Adatok sikeresen betöltve. Adatbázis: ${partnerDatabase.length} eszköz.`, false);
            renderEjkTable(); // Táblázat renderelése az EJK főképernyőn
        }
    }

    async function showEnyScreen(partnerFolder) {
        // Beállítjuk az aktuális partnert, hogy a segédfüggvények (pl. loadCompanyData) helyesen működjenek
        currentPartner = { name: partnerFolder.name, folderId: partnerFolder.id };

        showScreen('enyMain');
        
        // Betöltjük a cégadatokat, hogy a fejlécben a hivatalos nevet tudjuk megjeleníteni
        const companyDataLoaded = await loadCompanyData(partnerFolder.id, 'enyStatus');
        screens.enyMain.innerHTML = getEnyMainHtml(); // HTML generálás a betöltött adatokkal
        
        const dbLoaded = await loadDatabase(partnerFolder.id, 'enyStatus');
        if (dbLoaded) {
            renderEnyTable();
        }
    }

    // --- ADATBÁZIS KEZELÉS ---
    async function loadDatabase(folderId, statusElementId){
        setStatus(statusElementId, '<div class="loader mx-auto"></div><p class="mt-2">Adatbázis (`adatbazis.xlsx`) keresése...</p>');
        try {
            const response = await gapi.client.drive.files.list({
                q: `'${folderId}' in parents and name='adatbazis.xlsx' and trashed=false`, fields: 'files(id, name)'
            });
            if (response.result.files.length > 0) {
                 const fileId = response.result.files[0].id;
                 currentPartner.databaseFileId = fileId; 
                 setStatus(statusElementId, `<div class="loader mx-auto"></div><p class="mt-2">Adatbázis letöltése...</p>`);
                 const fileResponse = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                 const workbook = XLSX.read(fileResponse.body, { type: 'binary' });
                 partnerDatabase = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {raw: false, dateNF:'yyyy-mm-dd'});
                 setStatus(statusElementId, `Adatbázis sikeresen betöltve, ${partnerDatabase.length} eszközzel.`, false);
                 return true;
            } else {
                 setStatus(statusElementId, 'Nem található `adatbazis.xlsx` fájl a partnermappában.', true);
                 partnerDatabase = []; return false;
            }
        } catch (err) {
            setStatus(statusElementId, 'Hiba történt az adatbázis beolvasása közben.', true);
            partnerDatabase = []; return false;
        }
    }

    async function loadCompanyData(folderId, statusElementId) {
        setStatus(statusElementId, '<div class="loader mx-auto"></div><p class="mt-2">Cégadatok (`ceg.xlsx`) keresése...</p>');
        try {
            const response = await gapi.client.drive.files.list({
                q: `'${folderId}' in parents and name='ceg.xlsx' and trashed=false`, fields: 'files(id, name)'
            });
            if (response.result.files.length > 0) {
                const fileId = response.result.files[0].id;
                currentPartner.companyDataFileId = fileId;
                const fileResponse = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                const workbook = XLSX.read(fileResponse.body, { type: 'binary' });
                const companyDataArray = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                if (companyDataArray.length > 0) {
                    companyData = companyDataArray[0];
                    // ETAR kód generálása, ha szükséges
                    if (!findValue(companyData, 'ETAR kód')) {
                        const sourceString = `${findValue(companyData, 'Cégnév')}-${findValue(companyData, 'Cím')}`;
                        const encoder = new TextEncoder();
                        const dataBuffer = encoder.encode(sourceString);
                        const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                        companyData['ETAR kód'] = hashHex.substring(0, 6).toUpperCase();
                        
                        // Visszaírás a Drive-ra
                        await updateCompanyDataOnDrive();
                    }
                    return true;
                }
            }
            setStatus(statusElementId, 'Nem található `ceg.xlsx` fájl vagy üres. Kérlek, ellenőrizd a partner mappáját!', true);
            companyData = {};
            return false;
        } catch (err) {
            setStatus(statusElementId, 'Hiba történt a cégadatok beolvasása közben.', true);
            companyData = {};
            return false;
        }
    }

    async function updateCompanyDataOnDrive() {
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.json_to_sheet([companyData]); // A [companyData] fontos, mert a json_to_sheet tömböt vár
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Cégadatok');
        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        
        await uploadFile(currentPartner.companyDataFileId, blob);
    }

    function showUnauthorizedUser() { /* ... */ }
    function handleSignOut() {
        const token = gapi.client.getToken();
        if (token) {
            google.accounts.oauth2.revoke(token.access_token, () => {
                gapi.client.setToken('');
                userProfile = null; userRootFolderId = null; partnerDatabase = []; currentPartner = {};
                companyData = {}; showScreen('login');
                setStatus('loadingStatus', '');
            });
        }
    }
    
    // --- EJK FUNKCIÓK ---
    function showNewDeviceScreen(returnScreen, prefillData = {}) {
        newDeviceData = [];
        const screen = screens.dataEntry;
        screen.innerHTML = getNewDeviceHtml(returnScreen, prefillData);
        showScreen('dataEntry'); // A képernyő ID-ja 'dataEntryScreen' marad
    }

    function showEjkDocGeneration() {
        const screen = screens.ejkGenerateDocs;
        screen.innerHTML = getEjkDocGenerationHtml();
        showScreen('ejkGenerateDocs');
    }

    function showNewInspectionScreen() {
        const screen = screens.newInspection;
        screen.innerHTML = getNewInspectionScreenHtml(); // HTML generálás
        showScreen('newInspection');
        document.getElementById('serialNumberInput').focus();

        // Sablonok dinamikus betöltése az új képernyőre
        setTimeout(async () => {
            const selectEl = document.getElementById('templateSelectNewInspection');
            const statusEl = document.getElementById('templateStatusNewInspection');
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${currentPartner.folderId}' in parents and mimeType='application/vnd.openxmlformats-officedocument.wordprocessingml.document' and trashed=false`,
                    fields: 'files(id, name)'
                });
                if (response.result.files && response.result.files.length > 0) {
                    selectEl.innerHTML = ''; // Töröljük a "betöltés" opciót
                    response.result.files.forEach(file => {
                        const option = new Option(file.name, file.id);
                        selectEl.add(option);
                    });
                    statusEl.textContent = '';
                    selectEl.disabled = false;
                } else {
                    statusEl.textContent = 'Nem található .docx sablon a partner mappájában.';
                }
            } catch (err) {
                statusEl.textContent = 'Hiba a sablonok betöltésekor.';
            }
        }, 100);
    }

    function handleSearchDeviceBySerial() {
        const serialNumber = document.getElementById('serialNumberInput').value.trim();
        const resultDiv = document.getElementById('deviceSearchResult');

        if (!serialNumber) {
            resultDiv.innerHTML = `<p class="text-yellow-400">Kérlek, add meg a keresendő gyári számot!</p>`;
            return;
        }

        const device = partnerDatabase.find(d => findValue(d, 'Gyári szám').toLowerCase() === serialNumber.toLowerCase());

        if (device) {
            currentInspectedDevice = device; // Eltároljuk a megtalált eszközt
            let detailsHtml = '<h3 class="text-xl font-bold mb-4 text-green-300">Megtalált eszköz adatai</h3>';
            detailsHtml += '<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-left">';
            
            Object.entries(device).forEach(([key, value]) => {
                // A Cégnév és Cím adatokat nem jelenítjük meg, mert azok a partnerhez tartoznak, nem az eszközhöz.
                if (key.toLowerCase() !== 'cégnév' && key.toLowerCase() !== 'cím') {
                    detailsHtml += `
                        <div class="border-b border-blue-800 py-1">
                            <span class="text-blue-300 text-sm">${key}:</span>
                            <p class="font-semibold text-white break-words">${value || '-'}</p>
                        </div>
                    `;
                }
            });
            detailsHtml += '</div>' + getNewInspectionDataFormHtml(); // Hozzáadjuk az új adatbeviteli űrlapot
            resultDiv.innerHTML = detailsHtml;

            // A "Kész" gomb kezdeti állapotának beállítása
            updateNewInspectionFinishButtonState();
        } else {
            currentInspectedDevice = null; // Nincs találat, töröljük a referenciát
            resultDiv.innerHTML = `
                <p class="text-red-400 font-bold mb-4">Nem található eszköz ezzel a gyári számmal: "${serialNumber}"</p>
                <p class="mb-4">Szeretnéd új eszközként rögzíteni?</p>
                <button id="registerNewDeviceFromSearchBtn" data-serial-number="${serialNumber}" class="btn btn-success">Új eszköz rögzítése</button>
            `;
        }
    }
    
    function resetNewInspectionScreen() {
        const resultDiv = document.getElementById('deviceSearchResult');
        const serialInput = document.getElementById('serialNumberInput');

        currentInspectedDevice = null; // Töröljük a referenciát
        resultDiv.innerHTML = '<p class="text-gray-400">A keresés eredménye itt fog megjelenni.</p>';
        if(serialInput) {
            serialInput.value = '';
            serialInput.focus();
        }
    }

    async function handleFinishNewInspection() {
        if (!currentInspectedDevice) {
            alert("Hiba: Nincs kiválasztott eszköz a mentéshez.");
            return;
        }

        const finishBtn = document.getElementById('finishNewInspectionBtn');
        const originalBtnText = finishBtn.innerHTML;
        finishBtn.disabled = true;
        finishBtn.innerHTML = `<div class="loader mx-auto" style="height: 24px; width: 24px; border-width: 3px;"></div><span class="ml-2">Mentés folyamatban...</span>`;

        try {
            // 1. Adatok összegyűjtése az űrlapokról
            const newData = {
                'Vizsgálat helye': document.getElementById('inspectionLocationInput').value,
                'Vizsgálat időpontja': document.getElementById('inspectionDateInput').value,
                'Vizsgáló': document.getElementById('expertSelectNewInspection').value,
                'Vizsgálat jellege': document.getElementById('inspectionTypeNew').value,
                'Következő időszakos vizsgálat': document.getElementById('nextInspectionDateNew').value,
                'Következő terhelési próba': document.getElementById('nextLoadTestDateNew').value,
                'Megállapítások': document.getElementById('inspectionResultNew').value,
                'Feltárt hiba': document.getElementById('foundFaultNew').value,
                'Felhasznált anyagok': document.getElementById('actionsTakenNew').value,
            };

            // 2. Megfelelő rekord megkeresése és frissítése a `partnerDatabase`-ben
            const deviceIndex = partnerDatabase.findIndex(d => findValue(d, 'Gyári szám') === findValue(currentInspectedDevice, 'Gyári szám'));
            if (deviceIndex === -1) {
                throw new Error("A frissítendő eszköz nem található az adatbázisban.");
            }

            // A meglévő adatok frissítése az újakkal
            Object.keys(newData).forEach(key => {
                partnerDatabase[deviceIndex][key] = newData[key];
            });

            // 3. Excel fájl generálása és feltöltése a Drive-ra
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(partnerDatabase);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Adatok');
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

            await uploadFile(currentPartner.databaseFileId, blob);

            // 4. Sikeres mentés után a felület visszaállítása
            alert('Vizsgálati adatok sikeresen mentve!');
            renderEjkTable(); // A főmenü táblázatának frissítése a háttérben
            resetNewInspectionScreen();

        } catch (err) {
            alert(`Hiba történt a mentés során: ${err.message}`);
        } finally {
            finishBtn.disabled = false;
            finishBtn.innerHTML = originalBtnText;
        }
    }

    function updateNewInspectionFinishButtonState() {
        const finishBtn = document.getElementById('finishNewInspectionBtn');
        const expertSelect = document.getElementById('expertSelectNewInspection');
        const templateSelect = document.getElementById('templateSelectNewInspection');
        const locationInput = document.getElementById('inspectionLocationInput');
        const dateInput = document.getElementById('inspectionDateInput');
        // Új mezők
        const inspectionTypeNew = document.getElementById('inspectionTypeNew');
        const nextInspectionDateNew = document.getElementById('nextInspectionDateNew');
        const inspectionResultNew = document.getElementById('inspectionResultNew');

        if (finishBtn && expertSelect && templateSelect && locationInput && dateInput && inspectionTypeNew && nextInspectionDateNew && inspectionResultNew) {
            const isFormValid = templateSelect.value && 
                              expertSelect.value && 
                              locationInput.value.trim() && 
                              dateInput.value &&
                              inspectionTypeNew.value &&
                              nextInspectionDateNew.value &&
                              inspectionResultNew.value.trim();
            finishBtn.disabled = !isFormValid;
            finishBtn.title = isFormValid ? 'Befejezés és ugrás a következő eszközre' : 'A folytatáshoz kérjük, töltse ki az összes kötelező vizsgálati adatot (sablon, szakértő, hely, időpont, vizsgálat jellege, következő vizsgálat dátuma, megállapítások)!';
        }
    }

    function getNewInspectionDataFormHtml() {
        const today = new Date().toISOString().slice(0, 10);
        return `
            <div id="newInspectionDataEntry" class="mt-6 pt-6 border-t border-blue-700">
                <h3 class="text-xl font-bold mb-4 text-teal-300">Vizsgálati adatok rögzítése</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-left">
                    <div class="md:col-span-2">
                        <label class="block text-sm mb-1">Vizsgálat jellege</label>
                        <select name="vizsgalat_jellege_new" id="inspectionTypeNew" class="input-field" required>
                            <option value="" disabled selected>Válassz vizsgálati jelleget...</option>
                            <option>Szerkezeti vizsgálat</option>
                            <option>Fővizsgálat</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm mb-1">Következő időszakos vizsgálat</label>
                        <input name="kov_idoszakos_vizsgalat_new" id="nextInspectionDateNew" type="date" class="input-field" value="${today}">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm mb-1">Következő Terhelési próba</label>
                        <input name="kov_terhelesi_proba_new" id="nextLoadTestDateNew" type="date" class="input-field">
                    </div>
                    <div class="md:col-span-2"><label class="block text-sm mb-1">Vizsgálat eredménye (Megállapítások)</label><textarea name="megallapitasok_new" id="inspectionResultNew" rows="3" class="input-field"></textarea></div>
                    <div class="md:col-span-2"><label class="block text-sm mb-1">Feltárt hiba</label><textarea name="hiba_new" id="foundFaultNew" rows="3" class="input-field"></textarea></div>
                    <div class="md:col-span-2"><label class="block text-sm mb-1">Felhasznált anyagok</label><textarea name="intezkedes_new" id="actionsTakenNew" rows="3" class="input-field"></textarea></div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 mt-6">
                    <button type="button" id="copyPreviousInspectionDataBtn" class="btn btn-info w-full sm:w-auto">Előző adatok másolása</button>
                    <button id="finishNewInspectionBtn" class="btn btn-success w-full" disabled>Kész, következő eszköz</button>
                </div>
            </div>`;
    }

    function handleAddAnotherDeviceEjk() {
        const form = document.getElementById('dataEntryFormEjk');
        const formData = new FormData(form);
        const currentData = {};
        formData.forEach((value, key) => currentData[key] = value.trim());
        
        if (!currentData.eszkoz_megnevezes || !currentData.eszkoz_gyariszam) {
             alert('A "Megnevezés" és a "Gyári szám" mezők kitöltése kötelező!');
             return;
        }

        // Ellenőrzés, hogy a gyári szám létezik-e már
        const serialNumber = currentData.eszkoz_gyariszam;
        const isDuplicate = partnerDatabase.some(device => findValue(device, 'Gyári szám').toLowerCase() === serialNumber.toLowerCase()) ||
                            newDeviceData.some(device => findValue(device, 'Gyári szám').toLowerCase() === serialNumber.toLowerCase());
        if (isDuplicate) {
            alert(`A(z) "${serialNumber}" gyári szám már szerepel az adatbázisban vagy a most hozzáadott tételek között. Kérjük, adjon meg egy másikat!`);
            return;
        }

        lastDeviceData = { ...currentData };
        
        const newRecord = {
            'Cégnév': findValue(companyData, 'Cégnév') || currentPartner.name,
            'Cím': findValue(companyData, 'Cím') || '',
            'Megnevezés': currentData.eszkoz_megnevezes,
            'Üzemeltetői azonosító': currentData.eszkoz_uzemeltetoi_azonosito,
            'Típus': currentData.eszkoz_tipus,            
            'Hasznos hossz': currentData.eszkoz_hossz,
            'Teherbírás (WLL)': currentData.eszkoz_teherbiras,
            'Gyártó': currentData.eszkoz_gyarto,
            'Gyári szám': currentData.eszkoz_gyariszam,
            'Gyártás éve': currentData.gyartas_eve,
            'ETAR kód': '',
        };
        newDeviceData.push(newRecord);
        
        const notificationEl = document.getElementById('notificationEjk');
        notificationEl.textContent = `'${currentData.eszkoz_megnevezes}' hozzáadva. Összesen: ${newDeviceData.length} új tétel.`;
        setTimeout(() => { notificationEl.textContent = ''; }, 3000);
        
        form.reset();
        form.querySelectorAll('input, textarea').forEach(input => {
            input.placeholder = input.name === 'eszkoz_gyariszam' ? '' : lastDeviceData[input.name] || '';
        });
    }

    // --- BIZTONSÁGI MENTÉS MEGERŐSÍTÉSSEL ---
    function showSaveConfirmation() {
        const form = document.getElementById('dataEntryFormEjk');
        const formData = new FormData(form);
        const currentData = {};
        formData.forEach((value, key) => currentData[key] = value.trim());
        
        if (currentData.eszkoz_megnevezes && currentData.eszkoz_gyariszam) {
            // Ellenőrzés, hogy a gyári szám létezik-e már
            const serialNumber = currentData.eszkoz_gyariszam;
            const isDuplicate = partnerDatabase.some(device => findValue(device, 'Gyári szám').toLowerCase() === serialNumber.toLowerCase()) ||
                                newDeviceData.some(device => findValue(device, 'Gyári szám').toLowerCase() === serialNumber.toLowerCase());
            if (isDuplicate) {
                alert(`A(z) "${serialNumber}" gyári szám már szerepel az adatbázisban vagy a most hozzáadott tételek között. A mentés előtt kérjük, javítsa vagy törölje az űrlap tartalmát!`);
                // Nem adjuk hozzá a duplikált adatot, de a megerősítést megmutatjuk a korábban hozzáadottakkal.
            } else {
                // Csak akkor adjuk hozzá, ha nem duplikált
             const newRecord = {
                'Cégnév': findValue(companyData, 'Cégnév') || currentPartner.name,
                'Cím': findValue(companyData, 'Cím') || '',
                'Megnevezés': currentData.eszkoz_megnevezes,
                'Üzemeltetői azonosító': currentData.eszkoz_uzemeltetoi_azonosito,
                'Típus': currentData.eszkoz_tipus,                
                'Hasznos hossz': currentData.eszkoz_hossz,
                'Teherbírás (WLL)': currentData.eszkoz_teherbiras,
                'Gyártó': currentData.eszkoz_gyarto,
                'Gyári szám': currentData.eszkoz_gyariszam,
                'Gyártás éve': currentData.gyartas_eve,
                'ETAR kód': '',
            };
             newDeviceData.push(newRecord);
             form.reset();
            }
        }

        if (newDeviceData.length === 0) {
            alert('Nincs menthető új adat.');
            return;
        }

        const modal = document.getElementById('confirmationModal');
        const statsDiv = document.getElementById('modalStats');
        statsDiv.innerHTML = `
            <p>Partner: <span class="font-bold text-blue-300">${currentPartner.name}</span></p>
            <p>Eredeti sorok száma: <span class="font-bold text-blue-300">${partnerDatabase.length}</span></p>
            <p>Új sorok száma: <span class="font-bold text-yellow-300">${newDeviceData.length}</span></p>
            <hr class="my-2 border-slate-600">
            <p>Új teljes sorok száma: <span class="font-bold text-green-300">${partnerDatabase.length + newDeviceData.length}</span></p>
        `;
        
        modal.classList.remove('hidden');

        const returnScreen = document.getElementById('saveToDriveBtnEjk').dataset.returnScreen;

        document.getElementById('modalCancelBtn').onclick = () => modal.classList.add('hidden');
        document.getElementById('modalConfirmBtn').onclick = () => {
            document.getElementById('modalConfirmBtn').dataset.returnScreen = returnScreen;
            modal.classList.add('hidden');
            executeUpdateOnDrive();
        };
    }

    async function executeUpdateOnDrive() {
        const notificationEl = document.getElementById('notificationEjk');
        notificationEl.innerHTML = '<div class="loader mx-auto"></div><p>Adatbázis frissítése a Google Drive-on...</p>';
        
        const updatedDataForSheet = [...partnerDatabase, ...newDeviceData];

        if (!currentPartner.databaseFileId) {
            notificationEl.textContent = 'Hiba: Az adatbázis fájl azonosítója nem található!';
            notificationEl.className = 'text-center my-4 text-red-400 font-semibold h-auto';
            return;
        }

        try {
            // 1. Excel fájl létrehozása memóriában
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(updatedDataForSheet);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Adatok');
            
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

            await uploadFile(currentPartner.databaseFileId, blob);
            partnerDatabase = [...updatedDataForSheet];

            notificationEl.className = 'text-center my-4 text-green-400 font-semibold h-auto';
            notificationEl.textContent = `Az 'adatbazis.xlsx' sikeresen frissítve a Drive-on!`;
            setTimeout(() => {
                newDeviceData = []; lastDeviceData = {};
                const returnScreen = document.getElementById('modalConfirmBtn').dataset.returnScreen;
                if (returnScreen === 'enyMain') {
                    showEnyScreen({ name: currentPartner.name, id: currentPartner.folderId });
                } else { // ejkMain
                    showScreen('ejkMain');
                    renderEjkTable(); // Táblázat frissítése az új adatokkal
                }
            }, 4000);
        } catch (err) {
            const errorDetails = err.message || err.toString();
            notificationEl.className = 'text-center my-4 text-red-400 font-semibold h-auto';
            notificationEl.textContent = `Hiba a Drive-ra mentés során: ${errorDetails}`;
        }
    }

    function handleDownloadDatabase() {
        if (!partnerDatabase || partnerDatabase.length === 0) {
            alert('Nincs letölthető adat, az adatbázis üres.');
            return;
        }

        try {
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(partnerDatabase);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Adatok');
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, `adatbazis_${currentPartner.name}.xlsx`);
        } catch (err) {
            alert(`Hiba történt az Excel fájl generálása során: ${err.message}`);
        }
    }

    async function uploadFile(fileId, blob) {
        const accessToken = gapi.client.getToken().access_token;
        const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': blob.type
            },
            body: blob
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
        }
        return await response.json();
    }

    async function handleProcessFilesEjk() {
        const statusEl = document.getElementById('generationStatusEjk');
        const selectedCheckboxes = document.querySelectorAll('#deviceListEjk input[type="checkbox"]:checked');
        const templateFileId = document.getElementById('templateSelectEjk').value;
    
        if (selectedCheckboxes.length === 0) {
            alert('Kérlek, válassz ki legalább egy eszközt a listából!');
            return;
        }
        if (!templateFileId) {
            alert('Kérlek, válassz egy jegyzőkönyv sablont!');
            return;
        }
    
        statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Sablonfájl letöltése...</p>`;
        let tempFolderId = null;
    
        try {
            // === 1. FÁZIS: Ideiglenes mappa létrehozása és PDF-ek generálása a Drive-on ===
            const now = new Date();
            const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}`;
            const tempFolderName = `Jegyzokonyvek_temp_${timestamp}`;
    
            statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Ideiglenes mappa létrehozása...</p>`;
            const folderMetadata = {
                'name': tempFolderName,
                'mimeType': 'application/vnd.google-apps.folder',
                'parents': [currentPartner.folderId]
            };
            const folderResponse = await gapi.client.drive.files.create({ resource: folderMetadata, fields: 'id' });
            tempFolderId = folderResponse.result.id;
    
            const templateResponse = await gapi.client.drive.files.get({ fileId: templateFileId, alt: 'media' });
            const templateContent = templateResponse.body;
    
            const generatedPdfIds = [];
            const skippedItems = [];
    
            for (let i = 0; i < selectedCheckboxes.length; i++) {
                const checkbox = selectedCheckboxes[i];
                const deviceIndex = parseInt(checkbox.dataset.deviceIndex, 10);
                const deviceData = partnerDatabase[deviceIndex];
                const deviceName = findValue(deviceData, 'Megnevezés');

                // ELLENŐRZÉS: Van-e megállapítás? Ha nincs, kihagyjuk.
                if (!findValue(deviceData, 'Megállapítások')) {
                    const serial = findValue(deviceData, 'Gyári szám');
                    skippedItems.push(deviceName || serial);
                    continue; // Ugrás a következő elemre
                }

                // Szakértő adatainak kinyerése közvetlenül az eszköz adataiból
                const expertName = findValue(deviceData, 'Vizsgáló');
                const expertId = expertIds[expertName];
                if (!expertName || !expertId) {
                    // Ha valamiért hiányzik a vizsgáló, átugorjuk a generálást ennél az eszköznél
                    throw new Error(`A(z) "${deviceName}" eszközhöz nincs érvényes vizsgáló rendelve. A generálás leállt.`);
                }
    
                statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Feldolgozás: ${i + 1}/${selectedCheckboxes.length} (${deviceName})</p>`;
                const docxData = await generateDocxData(deviceData, { name: expertName, id: expertId });
                
                // Új adatok hozzáadása a `partnerDatabase` megfelelő sorához
                const originalDeviceData = partnerDatabase[deviceIndex];
                originalDeviceData['Sorszám'] = docxData.sorszam;
                originalDeviceData['Kelt'] = docxData.kelt;
                originalDeviceData['Időbélyeg'] = docxData.idobelyeg;
                originalDeviceData['Vizsgáló'] = docxData.szakerto_neve;

                const zip = new PizZip(templateContent);
                const doc = new docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
                doc.setData(docxData);
                try {
                    doc.render();
                } catch (error) {
                    console.error("Docxtemplater hiba:", JSON.stringify({error: error, data: docxData}));
                    throw error;
                }
                const generatedDoc = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });
    
                statusEl.innerHTML = `<div class="loader mx-auto"></div><p>PDF konvertálás: ${i + 1}/${selectedCheckboxes.length}</p>`;
                const pdfBlob = await convertDocxToPdf(generatedDoc);
    
                const pdfFileName = `${findValue(deviceData, 'Típus')}_${findValue(deviceData, 'Gyári szám')}_jkv.pdf`.replace(/[^a-zA-Z0-9_.-]/g, '_');
                const pdfMetadata = { 'name': pdfFileName, 'parents': [tempFolderId] };
                const pdfForm = new FormData();
                pdfForm.append('metadata', new Blob([JSON.stringify(pdfMetadata)], { type: 'application/json' }));
                pdfForm.append('file', pdfBlob);
    
                const pdfUploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                    body: pdfForm
                });
                const uploadedPdf = await pdfUploadRes.json();
                if (!uploadedPdf.id) throw new Error(`PDF feltöltése sikertelen: ${pdfFileName}`);
                generatedPdfIds.push({ id: uploadedPdf.id, name: pdfFileName });
            }
    
            if (generatedPdfIds.length === 0) {
                statusEl.className = 'text-center my-4 text-yellow-400 font-semibold h-auto';
                statusEl.textContent = `Nem készült egyetlen jegyzőkönyv sem. A kiválasztott ${skippedItems.length} tétel mindegyikéből hiányzott a "Megállapítások" mező.`;
                return; // A finally blokk lefut, de a többi lépést kihagyjuk.
            }

            // === 2. FÁZIS: PDF-ek letöltése a böngészőbe és ZIP készítése ===
            statusEl.innerHTML = `<div class="loader mx-auto"></div><p>ZIP archívum készítése...</p>`;
            const zip = new JSZip();
    
            for (let i = 0; i < generatedPdfIds.length; i++) {
                const fileInfo = generatedPdfIds[i];
                statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Fájl hozzáadása a ZIP-hez: ${i + 1}/${generatedPdfIds.length} (${fileInfo.name})</p>`;
                const fileResponse = await gapi.client.drive.files.get({ fileId: fileInfo.id, alt: 'media' });
                zip.file(fileInfo.name, fileResponse.body, { binary: true });
            }
    
            statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Véglegesítés... A letöltés hamarosan indul.</p>`;
            const zipBlob = await zip.generateAsync({ type: "blob" });
            saveAs(zipBlob, `Jegyzokonyvek_${currentPartner.name}_${timestamp}.zip`);
    
            statusEl.className = 'text-center my-4 text-green-400 font-semibold h-auto';
            let successMessage = `Sikeres generálás! A(z) ${generatedPdfIds.length} jegyzőkönyvet tartalmazó ZIP fájl letöltése elindult.`;
            if (skippedItems.length > 0) {
                successMessage += ` (${skippedItems.length} tétel kihagyva hiányzó megállapítások miatt.)`;
            }
            statusEl.textContent = successMessage;

            // Az adatbázis frissítése a Drive-on az új metaadatokkal
            statusEl.innerHTML += '<p class="text-sm text-slate-400 mt-2">Adatbázis frissítése a metaadatokkal...</p>';
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(partnerDatabase);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Adatok');
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            await uploadFile(currentPartner.databaseFileId, blob);
    
        } catch (err) {
            const errorDetails = err.result?.error?.message || err.message || err.toString();
            statusEl.className = 'text-center my-4 text-red-400 font-semibold h-auto';
            statusEl.textContent = `Hiba a feldolgozás során: ${errorDetails}`;
        } finally {
            // === 3. FÁZIS: Ideiglenes mappa törlése ===
            if (tempFolderId) {
                statusEl.innerHTML += '<p class="text-sm text-slate-400 mt-2">Ideiglenes fájlok törlése a Drive-ról...</p>';
                try {
                    await gapi.client.drive.files.delete({ fileId: tempFolderId });
                    statusEl.innerHTML = statusEl.innerHTML.replace('<p class="text-sm text-slate-400 mt-2">Ideiglenes fájlok törlése a Drive-ról...</p>', '<p class="text-sm text-slate-500 mt-2">Takarítás befejezve.</p>');
                } catch (cleanupErr) {
                    console.error("Hiba az ideiglenes mappa törlésekor:", cleanupErr);
                    statusEl.innerHTML += '<p class="text-sm text-red-500 mt-1">Az ideiglenes mappa törlése sikertelen. Kérlek, manuálisan töröld a Drive-ról!</p>';
                }
            }
        }
    }

    async function handleDeleteSelectedEjk() {
        const statusEl = document.getElementById('generationStatusEjk');
        const selectedCheckboxes = document.querySelectorAll('#deviceListEjk input[type="checkbox"]:checked:not(#selectAllCheckboxEjk)');

        if (selectedCheckboxes.length === 0) {
            alert('Kérjük, válasszon ki legalább egy eszközt a törléshez!');
            return;
        }

        // 1. Első megerősítés
        const firstConfirm = confirm(`Biztosan törölni szeretné a kiválasztott ${selectedCheckboxes.length} eszközt az adatbázisból? Ez a művelet nem vonható vissza!`);
        if (!firstConfirm) {
            return;
        }

        // 2. Második, nyomatékosabb megerősítés
        const secondConfirm = prompt(`A törlés végleges! A folytatáshoz írja be a következő szót: TÖRLÉS`);
        if (secondConfirm !== 'TÖRLÉS') {
            alert('A megerősítés sikertelen, a törlés megszakítva.');
            return;
        }

        statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Kijelölt elemek törlése és az adatbázis frissítése...</p>`;

        try {
            const indicesToDelete = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.deviceIndex, 10));
            partnerDatabase = partnerDatabase.filter((_, index) => !indicesToDelete.includes(index));

            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(partnerDatabase);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Adatok');
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            await uploadFile(currentPartner.databaseFileId, blob);

            statusEl.textContent = 'A kijelölt elemek törlése sikeres volt. A lista frissül...';
            renderDeviceList(); // A lista újrarajzolása a frissített adatokkal
        } catch (err) {
            statusEl.textContent = `Hiba történt a törlés során: ${err.message}`;
        }
    }

    async function convertDocxToPdf(docxBlob) {
        let tempDocId = null;
        try {
            const tempFileName = `temp_conversion_${Date.now()}.docx`;
            // A `multipart` feltöltést használjuk, ami egy lépésben tölt fel és konvertál.
            // Ez a megbízható módszer, ami az EJK felületen is működik.
            const fileMetadata = {
                'name': tempFileName,
                'parents': [currentPartner.folderId], // Ideiglenesen a partner mappájába kerül
                'mimeType': 'application/vnd.google-apps.document' // Célformátum: Google Docs
            };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
            form.append('file', docxBlob);
    
            const uploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                body: form
            });
            const uploadedFile = await uploadRes.json();
            if (!uploadedFile.id) throw new Error('Fájl konvertálása Google Docs formátumra sikertelen.');
            tempDocId = uploadedFile.id;
    
            const exportUrl = `https://www.googleapis.com/drive/v3/files/${tempDocId}/export?mimeType=application/pdf`;
            const pdfRes = await fetch(exportUrl, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` }
            });
            if (!pdfRes.ok) throw new Error('PDF exportálás sikertelen.');
            return await pdfRes.blob();
        } finally {
            if (tempDocId) {
                await gapi.client.drive.files.delete({ fileId: tempDocId });
            }
        }
    }

    function renderEjkTable() {
        const tableContainer = document.getElementById('ejkDeviceTable');
        if (!tableContainer) return;

        if (!partnerDatabase || partnerDatabase.length === 0) {
            tableContainer.innerHTML = '<p class="text-center text-gray-400 p-4">Nincs megjeleníthető eszköz az adatbázisban.</p>';
            return;
        }

        const sortedDatabase = [...partnerDatabase].sort((a, b) => {
            const valA = findValue(a, sortState.key);
            const valB = findValue(b, sortState.key);
            const direction = sortState.direction === 'asc' ? 1 : -1;
            return valA.localeCompare(valB, 'hu', { numeric: true }) * direction;
        });

        const tableHeader = `
            <thead>
                <tr class="bg-blue-950/70 sticky top-0">
                    <th data-sort-key="Vizsgálat időpontja" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Vizsg. Időp.</th>
                    <th data-sort-key="Megnevezés" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Megnevezés</th>
                    <th data-sort-key="Típus" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Típus</th>
                    <th data-sort-key="Hasznos hossz" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Hossz</th>
                    <th data-sort-key="Gyári szám" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Gyári szám</th>
                    <th data-sort-key="Megállapítások" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Megállapítások</th>
                    <th data-sort-key="Következő időszakos vizsgálat" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Köv. Vizsg.</th>
                </tr>
            </thead>
        `;

        const tableBody = sortedDatabase.map(device => {
            const inspectionDate = findValue(device, 'Vizsgálat időpontja');
            const deviceName = findValue(device, 'Megnevezés');
            const deviceType = findValue(device, 'Típus');
            const deviceLength = findValue(device, 'Hasznos hossz');
            const deviceSerial = findValue(device, 'Gyári szám');
            const deviceFindings = findValue(device, 'Megállapítások');
            const nextInspection = findValue(device, 'Következő időszakos vizsgálat');
            const dateClass = getInspectionDateClass(nextInspection);

            return `
                <tr class="border-b border-blue-900 hover:bg-blue-800/50">
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${inspectionDate}">${inspectionDate || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap" title="${deviceName}">${deviceName}</td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceType}">${deviceType || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceLength}">${deviceLength || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceSerial}">${deviceSerial}</td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceFindings}">${deviceFindings || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap ${dateClass}" title="${nextInspection}">${nextInspection || 'N/A'}</td>
                </tr>
            `;
        }).join('');

        tableContainer.innerHTML = `
            <div class="max-h-[50vh] overflow-y-auto border border-blue-800 rounded-lg text-left">
                <table class="min-w-full divide-y divide-blue-800">
                    ${tableHeader}
                    <tbody class="bg-blue-900/30 divide-y divide-blue-900">${tableBody}</tbody>
                </table>
            </div>
        `;
        updateSortIndicators();
    }

    async function handleGenerateProtocolsEny() {
        const statusEl = document.getElementById('enyStatus');
        const selectedCheckboxes = document.querySelectorAll('#enyDeviceTable input[type="checkbox"]:checked');

        if (selectedCheckboxes.length === 0) {
            alert('Kérlek, válassz ki legalább egy eszközt a listából a jegyzőkönyv generálásához!');
            return;
        }

        // Ellenőrzés: A kiválasztott eszközök mindegyikének van-e érvényes vizsgálati dátuma?
        for (const checkbox of selectedCheckboxes) {
            const deviceIndex = parseInt(checkbox.dataset.deviceIndex, 10);
            const device = partnerDatabase[deviceIndex];
            const nextInspection = findValue(device, 'Következő időszakos vizsgálat');
            if (!nextInspection || isNaN(new Date(nextInspection))) {
                const deviceName = findValue(device, 'Megnevezés') || `a(z) ${findValue(device, 'Gyári szám')} gyári számú`;
                alert(`A jegyzőkönyv generálás nem lehetséges, mert ${deviceName} eszközhöz nincs érvényes "Következő időszakos vizsgálat" dátum rögzítve.`);
                return;
            }
        }

        statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Folyamat előkészítése... Keresem a 'JKV_1.docx' sablont.</p>`;
        let tempFolderId = null;

        try {
            // 1. Sablonfájl megkeresése
            const templateResponse = await gapi.client.drive.files.list({
                q: `'${currentPartner.folderId}' in parents and name='JKV_1.docx' and trashed=false`,
                fields: 'files(id)'
            });

            if (!templateResponse.result.files || templateResponse.result.files.length === 0) {
                throw new Error("A kötelező 'JKV_1.docx' sablonfájl nem található a partner mappájában.");
            }
            const templateFileId = templateResponse.result.files[0].id;

            // 2. Ideiglenes mappa létrehozása a Drive-on
            const now = new Date();
            const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}`;
            const tempFolderName = `Jegyzokonyvek_temp_${timestamp}`;

            statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Ideiglenes mappa létrehozása...</p>`;
            const folderMetadata = { name: tempFolderName, mimeType: 'application/vnd.google-apps.folder', parents: [currentPartner.folderId] };
            const folderResponse = await gapi.client.drive.files.create({ resource: folderMetadata, fields: 'id' });
            tempFolderId = folderResponse.result.id;

            const templateFileResponse = await gapi.client.drive.files.get({ fileId: templateFileId, alt: 'media' });
            const templateContent = templateFileResponse.body;

            const generatedPdfIds = [];

            // 3. Kiválasztott eszközök feldolgozása
            for (let i = 0; i < selectedCheckboxes.length; i++) {
                const checkbox = selectedCheckboxes[i];
                const deviceIndex = parseInt(checkbox.dataset.deviceIndex, 10);
                const deviceData = partnerDatabase[deviceIndex];
                const deviceName = findValue(deviceData, 'Megnevezés');

                const expertName = findValue(deviceData, 'Vizsgáló');
                const expertId = expertIds[expertName];
                if (!expertName || !expertId) {
                    throw new Error(`A(z) "${deviceName}" eszközhöz nincs érvényes vizsgáló rendelve. A generálás leállt.`);
                }

                statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Jegyzőkönyv generálása: ${i + 1}/${selectedCheckboxes.length} (${deviceName})</p>`;
                const docxData = await generateDocxData(deviceData, { name: expertName, id: expertId });

                // Metaadatok frissítése a memóriában lévő adatbázisban
                partnerDatabase[deviceIndex]['Sorszám'] = docxData.sorszam;
                partnerDatabase[deviceIndex]['Kelt'] = docxData.kelt;
                partnerDatabase[deviceIndex]['Időbélyeg'] = docxData.idobelyeg;

                const zip = new PizZip(templateContent);
                const doc = new docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
                doc.setData(docxData);
                doc.render();
                const generatedDoc = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });

                const pdfBlob = await convertDocxToPdf(generatedDoc);
                const pdfFileName = `${findValue(deviceData, 'Típus')}_${findValue(deviceData, 'Gyári szám')}_jkv.pdf`.replace(/[^a-zA-Z0-9_.-]/g, '_');
                const pdfMetadata = { name: pdfFileName, parents: [tempFolderId] };
                const pdfForm = new FormData();
                pdfForm.append('metadata', new Blob([JSON.stringify(pdfMetadata)], { type: 'application/json' }));
                pdfForm.append('file', pdfBlob);

                const pdfUploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                    body: pdfForm
                });
                const uploadedPdf = await pdfUploadRes.json();
                if (!uploadedPdf.id) throw new Error(`PDF feltöltése sikertelen: ${pdfFileName}`);
                generatedPdfIds.push({ id: uploadedPdf.id, name: pdfFileName });
            }

            // 4. Adatbázis frissítése a Drive-on
            statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Adatbázis frissítése a metaadatokkal...</p>`;
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(partnerDatabase);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Adatok');
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            await uploadFile(currentPartner.databaseFileId, blob);

            // 5. ZIP archívum készítése és letöltése
            statusEl.innerHTML = `<div class="loader mx-auto"></div><p>ZIP archívum készítése...</p>`;
            const zip = new JSZip();
            for (let i = 0; i < generatedPdfIds.length; i++) {
                const fileInfo = generatedPdfIds[i];
                statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Fájl hozzáadása a ZIP-hez: ${i + 1}/${generatedPdfIds.length}</p>`;
                const fileResponse = await gapi.client.drive.files.get({ fileId: fileInfo.id, alt: 'media' });
                zip.file(fileInfo.name, fileResponse.body, { binary: true });
            }

            statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Véglegesítés... A letöltés hamarosan indul.</p>`;
            const zipBlob = await zip.generateAsync({ type: "blob" });
            saveAs(zipBlob, `Jegyzokonyvek_${currentPartner.name}_${timestamp}.zip`);

            statusEl.className = 'mt-4 text-center text-green-400 font-semibold';
            statusEl.textContent = `Sikeres generálás! A(z) ${selectedCheckboxes.length} jegyzőkönyvet tartalmazó ZIP fájl letöltése elindult.`;

        } catch (err) {
            const errorDetails = err.result?.error?.message || err.message || err.toString();
            statusEl.className = 'mt-4 text-center text-red-400 font-semibold';
            statusEl.textContent = `Hiba a feldolgozás során: ${errorDetails}`;
        } finally {
            if (tempFolderId) {
                await gapi.client.drive.files.delete({ fileId: tempFolderId });
            }
        }
    }

    async function handleDeleteSelectedEny() {
        const statusEl = document.getElementById('enyStatus');
        const selectedCheckboxes = document.querySelectorAll('#enyDeviceTable input[type="checkbox"]:checked:not(#selectAllCheckboxEny)');

        if (selectedCheckboxes.length === 0) {
            alert('Kérjük, válasszon ki legalább egy eszközt a törléshez!');
            return;
        }

        // 1. Első megerősítés
        const firstConfirm = confirm(`Biztosan törölni szeretné a kiválasztott ${selectedCheckboxes.length} eszközt az adatbázisból? Ez a művelet nem vonható vissza!`);
        if (!firstConfirm) {
            return;
        }

        // 2. Második, nyomatékosabb megerősítés
        const secondConfirm = prompt(`A törlés végleges! A folytatáshoz írja be a következő szót: TÖRLÉS`);
        if (secondConfirm !== 'TÖRLÉS') {
            alert('A megerősítés sikertelen, a törlés megszakítva.');
            return;
        }

        statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Kijelölt elemek törlése és az adatbázis frissítése...</p>`;

        try {
            const indicesToDelete = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.deviceIndex, 10));
            // A `partnerDatabase` frissítése: csak azokat tartjuk meg, amiknek az indexe nincs a törlendők listájában.
            partnerDatabase = partnerDatabase.filter((_, index) => !indicesToDelete.includes(index));

            // Adatbázis fájl frissítése a Drive-on
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(partnerDatabase);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Adatok');
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            await uploadFile(currentPartner.databaseFileId, blob);

            statusEl.textContent = 'A kijelölt elemek törlése sikeres volt. A táblázat frissül...';
            renderEnyTable(); // A táblázat újrarajzolása a frissített adatokkal
        } catch (err) {
            statusEl.textContent = `Hiba történt a törlés során: ${err.message}`;
        }
    }

    async function generateDocxData(data, expert) {
        const keyMap = {
            'Cégnév': 'uzemelteto_cegnev',
            'Cím':  'uzemelteto_cim',
            'Megnevezés': 'eszkoz_megnevezes',
            'Üzemeltetői azonosító': 'eszkoz_uzemeltetoi_azonosito',
            'Típus': 'eszkoz_tipus',
            'Hasznos hossz': 'eszkoz_hossz',
            'Teherbírás (WLL)': 'eszkoz_teherbiras',
            'Gyártó': 'eszkoz_gyarto',
            'Gyári szám': 'eszkoz_gyariszam',
            'Gyártás éve': 'gyartas_eve',
            'Vizsgálat helye': 'vizsgalat_helye',
            'Vizsgálat időpontja': 'vizsgalat_idopontja',
            'Vizsgálat jellege': 'vizsgalat_jellege',
            'Megállapítások': 'megallapitasok',
            'Feltárt hiba': 'hiba',
            'Felhasznált anyagok': 'intezkedes',
            'Következő időszakos vizsgálat': 'kovetkezo_idoszakos_vizsgalat',
            'Következő terhelési próba': 'kovetkezo_terhelesi_proba',
        };

        const templateData = {}; 
        // 1. Adatok átmásolása az Excelből, üres értékek cseréje kötőjelre
        Object.keys(keyMap).forEach(excelKey => {
            const templateKey = keyMap[excelKey];
            const value = findValue(data, excelKey);
            templateData[templateKey] = value.trim() === '' ? '-' : value;
        });

        // 2. Automatikusan generált adatok hozzáadása
        const now = new Date();
        templateData.kelt = now.toISOString().slice(0, 10);

        // Időbélyeg generálása SHA-256 hash alapján
        const inspectionDate = findValue(data, 'Vizsgálat időpontja');
        const serialNumberForHash = findValue(data, 'Gyári szám');
        const sourceString = `${inspectionDate}-${serialNumberForHash}`;
        
        const encoder = new TextEncoder();
        const dataBuffer = encoder.encode(sourceString);
        const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        templateData.idobelyeg = hashHex.substring(0, 12);
        
        // Sorszám generálása a megadott formátum szerint
        const partnerPrefix = currentPartner.name.substring(0, 4).toUpperCase();
        const deviceSerial = findValue(data, 'Gyári szám');
        const currentYear = now.getFullYear();
        templateData.sorszam = `${partnerPrefix}/${deviceSerial}/${currentYear}`;

        // 3. Szakértői adatok hozzáadása
        templateData.szakerto_neve = expert.name || '';
        templateData.szakerto_azonosito = expert.id || '';

        return templateData;
    }
    
    let sortState = { key: 'Megnevezés', direction: 'asc' };

    function handleSortEnyTable(key) {
        if (sortState.key === key) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.key = key;
            sortState.direction = 'asc';
        }
        renderEnyTable();
    }
    function handleSortDeviceList(key) {
        if (sortState.key === key) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.key = key;
            sortState.direction = 'asc';
        }
        renderDeviceList();
    }

    function renderDeviceList() {
        const sortedDatabase = [...partnerDatabase].sort((a, b) => {
            const valA = findValue(a, sortState.key);
            const valB = findValue(b, sortState.key);
            const direction = sortState.direction === 'asc' ? 1 : -1;
            return valA.localeCompare(valB, 'hu', { numeric: true }) * direction;
        });

        const tableHeader = `
            <thead class="bg-blue-950/70 sticky top-0">
                <tr>
                    <th class="p-3 w-12"><input type="checkbox" id="selectAllCheckboxEjk" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" title="Összes kijelölése/törlése"></th>
                    <th data-sort-key="Vizsgálat időpontja" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Vizsg. Időp.</th>
                    <th data-sort-key="Megnevezés" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Megnevezés</th>
                    <th data-sort-key="Típus" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Típus</th>
                    <th data-sort-key="Hasznos hossz" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Hossz</th>
                    <th data-sort-key="Gyári szám" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Gyári szám</th>
                    <th data-sort-key="Megállapítások" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Megállapítások</th>
                    <th data-sort-key="Következő időszakos vizsgálat" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Köv. Vizsg.</th>
                </tr>
            </thead>
        `;

        const tableBody = sortedDatabase.map(device => {
            const originalIndex = partnerDatabase.indexOf(device);
            const inspectionDate = findValue(device, 'Vizsgálat időpontja');
            const deviceName = findValue(device, 'Megnevezés');
            const deviceType = findValue(device, 'Típus');
            const deviceLength = findValue(device, 'Hasznos hossz');
            const deviceSerial = findValue(device, 'Gyári szám');
            const deviceFindings = findValue(device, 'Megállapítások');
            const nextInspection = findValue(device, 'Következő időszakos vizsgálat');
            const hasFindings = !!deviceFindings;
            const dateClass = getInspectionDateClass(nextInspection);

            return `
                <tr class="border-b border-blue-900 ${hasFindings ? 'hover:bg-blue-800/50' : 'opacity-50'}">
                    <td class="p-3 text-center"><input type="checkbox" id="device_${originalIndex}" data-device-index="${originalIndex}" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" title="Kiválasztás jegyzőkönyv generáláshoz"></td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${inspectionDate}">${inspectionDate || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap" title="${deviceName}">${deviceName}</td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceType}">${deviceType || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceLength}">${deviceLength || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceSerial}">${deviceSerial}</td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceFindings}">${deviceFindings || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap ${dateClass}" title="${nextInspection}">${nextInspection || 'N/A'}</td>
                </tr>
            `;
        }).join('');

        document.getElementById('deviceListEjk').innerHTML = `<table class="min-w-full divide-y divide-blue-800">${tableHeader}<tbody class="bg-blue-900/30 divide-y divide-blue-900">${tableBody}</tbody></table>` || '<p class="p-4 text-center text-gray-400">Nincs eszköz az adatbázisban.</p>';
        updateSortIndicators();
    }

    function updateSortIndicators() {
        document.querySelectorAll('[data-sort-key]').forEach(el => {
            el.classList.remove('text-white');
            el.innerHTML = el.innerHTML.replace(/ (↑|↓)$/, ''); // Remove old arrow
            if (el.dataset.sortKey === sortState.key) {
                el.classList.add('text-white');
                el.innerHTML += sortState.direction === 'asc' ? ' ↑' : ' ↓';
            }
        });
    }

    function getInspectionDateClass(dateString) {
        if (!dateString || isNaN(new Date(dateString))) {
            return 'text-gray-500'; // Alapértelmezett szín érvénytelen dátum esetén
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const inspectionDate = new Date(dateString);
        
        const diffTime = inspectionDate.getTime() - today.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 0) {
            return 'text-red-400 font-bold'; // Lejárt
        } else if (diffDays <= 45) {
            return 'text-orange-400 font-semibold'; // Hamarosan lejár
        }
        return 'text-green-400'; // Rendben
    }
    function renderEnyTable() {
        const tableContainer = document.getElementById('enyDeviceTable');
        if (!tableContainer) return;

        if (!partnerDatabase || partnerDatabase.length === 0) {
            tableContainer.innerHTML = '<p class="text-center text-gray-400 p-4">Nincs megjeleníthető eszköz az adatbázisban.</p>';
            return;
        }

        const sortedDatabase = [...partnerDatabase].sort((a, b) => {
            const valA = findValue(a, sortState.key);
            const valB = findValue(b, sortState.key);
            const direction = sortState.direction === 'asc' ? 1 : -1;
            // A 'hu' localeCompare biztosítja a helyes magyar ékezetes és numerikus rendezést
            return valA.localeCompare(valB, 'hu', { numeric: true }) * direction;
        });

        const tableHeader = `
            <thead>
                <tr class="bg-blue-950/70 sticky top-0">
                    <th class="p-3 w-12">
                        <input type="checkbox" id="selectAllCheckboxEny" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" title="Összes kijelölése/törlése">
                    </th>
                    <th data-sort-key="Típus" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Típus</th>
                    <th data-sort-key="Hasznos hossz" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Hossz</th>
                    <th data-sort-key="Gyári szám" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Gyári szám</th>
                    <th data-sort-key="Következő időszakos vizsgálat" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Köv. Vizsg.</th>
                    <th data-sort-key="Üzemeltetői azonosító" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Azonosító</th>
                    <th data-sort-key="Megnevezés" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Megnevezés</th>
                    <th data-sort-key="Megállapítások" class="p-3 text-left text-xs font-medium text-blue-300 uppercase tracking-wider cursor-pointer hover:text-white">Megállapítások</th>
                </tr>
            </thead>
        `;

        const tableBody = sortedDatabase.map((device, index) => {
            const deviceName = findValue(device, 'Megnevezés');
            const deviceType = findValue(device, 'Típus');
            const deviceLength = findValue(device, 'Hasznos hossz');
            const deviceSerial = findValue(device, 'Gyári szám');
            const deviceId = findValue(device, 'Üzemeltetői azonosító');
            const deviceFindings = findValue(device, 'Megállapítások');
            const nextInspection = findValue(device, 'Következő időszakos vizsgálat');
            const dateClass = getInspectionDateClass(nextInspection);

            const originalIndex = partnerDatabase.indexOf(device);

            return `
                <tr class="border-b border-blue-900 hover:bg-blue-800/50">
                    <td class="p-3 w-12 text-center">
                        <input type="checkbox" id="eny_device_${originalIndex}" data-device-index="${originalIndex}" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" title="Kijelölés művelethez">
                    </td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceType}">${deviceType}</td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceLength}">${deviceLength}</td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceSerial}">${deviceSerial}</td>
                    <td class="p-3 whitespace-nowrap ${dateClass}" title="${nextInspection}">${nextInspection || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceId}">${deviceId}</td>
                    <td class="p-3 whitespace-nowrap" title="${deviceName}">${deviceName}</td>
                    <td class="p-3 whitespace-nowrap text-gray-400" title="${deviceFindings}">${deviceFindings}</td>
                </tr>
            `;
        }).join('');

        tableContainer.innerHTML = `
            <div class="max-h-[60vh] overflow-y-auto border border-blue-800 rounded-lg">
                <table class="min-w-full divide-y divide-blue-800">
                    ${tableHeader}
                    <tbody class="bg-blue-900/30 divide-y divide-blue-900">
                        ${tableBody}
                    </tbody>
                </table>
            </div>
        `;
        updateSortIndicators();
    }

    // --- HTML GENERÁLÓ FÜGGVÉNYEK ---
    function getNewDeviceHtml(returnScreen, prefillData = {}) {
        const backButtonId = returnScreen === 'enyMain' ? 'backToEnyMainBtn' : 'backToEjkMainBtn';
        const backButtonText = returnScreen === 'enyMain' ? 'Vissza az adatbázishoz' : 'Vissza a főmenübe';

        return `
            <header class="bg-blue-950/70 p-4 rounded-t-xl mb-1 shadow-lg border-b border-blue-800">
                <h2 class="text-xl font-bold text-center">Adatbevitel - ${currentPartner.name}</h2>
            </header>
            <div class="card rounded-t-none">
                <h3 class="text-xl font-semibold border-b border-blue-700 pb-2 mb-6">Új eszköz alapadatai</h3>
                 <form id="dataEntryFormEjk" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <!-- Bal oszlop -->
                    <div><label class="block text-sm">Megnevezés</label><input name="eszkoz_megnevezes" class="input-field" required value="${prefillData.eszkoz_megnevezes || ''}"></div>
                    <div><label class="block text-sm">Gyári szám</label><input name="eszkoz_gyariszam" class="input-field" required value="${prefillData.eszkoz_gyariszam || ''}"></div>
                    <div><label class="block text-sm">Típus</label><input name="eszkoz_tipus" class="input-field" value="${prefillData.eszkoz_tipus || ''}"></div>
                    <div><label class="block text-sm">Gyártó</label><input name="eszkoz_gyarto" class="input-field" value="${prefillData.eszkoz_gyarto || ''}"></div>
                    <div><label class="block text-sm">Hasznos hossz</label><input name="eszkoz_hossz" class="input-field" value="${prefillData.eszkoz_hossz || ''}"></div>
                    <div><label class="block text-sm">Gyártás éve</label><input name="gyartas_eve" class="input-field" value="${prefillData.gyartas_eve || ''}"></div>
                    <div><label class="block text-sm">Teherbírás (WLL)</label><input name="eszkoz_teherbiras" class="input-field" value="${prefillData.eszkoz_teherbiras || ''}"></div>
                    <div><label class="block text-sm">Üzemeltetői azonosító</label><input name="eszkoz_uzemeltetoi_azonosito" class="input-field" value="${prefillData.eszkoz_uzemeltetoi_azonosito || ''}"></div>
                    
                    <!-- Jobb oszlop -->
                </form>
                <div id="notificationEjk" class="text-center my-4 text-green-400 font-semibold h-6"></div>
                <div class="flex flex-col sm:flex-row gap-4 justify-between mt-6">
                    <button id="${backButtonId}" class="btn btn-secondary">${backButtonText}</button>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="addAnotherDeviceBtnEjk" class="btn btn-primary">Adatok hozzáadása és új eszköz</button>
                        <button id="saveToDriveBtnEjk" data-return-screen="${returnScreen}" class="btn btn-success">Változtatások mentése a Drive-ra</button>
                    </div>
                </div>
            </div>`;
    }
    function getEjkDocGenerationHtml() {
        // Dinamikusan betöltjük a sablonokat, miután a HTML a DOM-ba került
        setTimeout(async () => {
            renderDeviceList(); // Lista kirajzolása a rendezés alapján

            const selectEl = document.getElementById('templateSelectEjk');
            const statusEl = document.getElementById('templateStatusEjk');
            const generateBtn = document.getElementById('processFilesBtnEjk');
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${currentPartner.folderId}' in parents and mimeType='application/vnd.openxmlformats-officedocument.wordprocessingml.document' and trashed=false`,
                    fields: 'files(id, name)'
                });
                if (response.result.files && response.result.files.length > 0) {
                    selectEl.innerHTML = ''; // Töröljük a "betöltés" opciót
                    response.result.files.forEach(file => {
                        const option = new Option(file.name, file.id);
                        selectEl.add(option);
                    });
                    statusEl.textContent = '';
                    selectEl.disabled = false;
                    generateBtn.disabled = false;
                } else {
                    statusEl.textContent = 'Nem található .docx sablon a partner mappájában.';
                }
            } catch (err) {
                statusEl.textContent = 'Hiba a sablonok betöltésekor.';
                console.error("Sablon betöltési hiba:", err);
            }
        }, 100);

        return `
            <div class="card max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-center mb-6">Jegyzőkönyv Készítés - ${currentPartner.name}</h2>                
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold mb-3">1. Eszközök kiválasztása</h3>
                        <div class="max-h-[60vh] overflow-y-auto border border-blue-800 rounded-lg text-left">
                            <div id="deviceListEjk"><div class="loader mx-auto p-8"></div></div>
                        </div>
                    </div>
                    <div class="space-y-6 md:w-1/3 flex-shrink-0">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">2. Sablon kiválasztása</h3>
                            <select id="templateSelectEjk" class="input-field" disabled><option>Sablonok betöltése...</option></select>
                            <p id="templateStatusEjk" class="text-sm text-yellow-400 mt-2 h-4"></p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3">3. Generálás indítása</h3>
                            <button id="processFilesBtnEjk" class="btn btn-success w-full" disabled>Jegyzőkönyvek generálása</button>
                            <div id="generationStatusEjk" class="text-center my-4 font-semibold h-12"></div>
                        </div>
                        <div class="border-t border-red-800/50 pt-4">
                            <h3 class="text-lg font-semibold mb-3 text-red-400">Veszélyes Zóna</h3>
                            <button id="deleteSelectedBtnEjk" class="btn btn-danger w-full">
                                Kiválasztottak törlése
                            </button>
                        </div>
                        <div class="mt-auto"></div> <!-- Pushes content up -->
                    </div>
                </div>
                <div class="mt-8 text-left">
                    <button id="backToEjkMainBtn" class="btn btn-secondary">Vissza a főmenübe</button>
                </div>
            </div>
        `;
    }
    
    function getEnyMainHtml() {
        const partnerDisplayName = findValue(companyData, 'Cégnév') || currentPartner.name;
        return `
            <div class="card max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold truncate pr-4" title="${partnerDisplayName}">Adatbázis - ${partnerDisplayName}</h1>
                    <div class="flex gap-2 flex-wrap justify-end flex-shrink-0">
                        <button id="enyNewDeviceBtn" class="btn btn-primary text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>Új eszköz</span>
                        </button>
                        <button id="generateProtocolsBtnEny" class="btn btn-success text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                            </svg>
                            <span>Jegyzőkönyvek</span>
                        </button>
                        <button id="deleteSelectedBtnEny" class="btn btn-danger text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                            </svg>
                            <span>Törlés</span>
                        </button>
                        <button id="downloadDbBtnEny" class="btn btn-info text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                            </svg>
                            <span>Letöltés</span>
                        </button>
                        <button id="signOutButtonEny" class="btn btn-secondary text-sm flex items-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                            </svg>
                            <span>Kijelentkezés</span>
                        </button>
                    </div>
                </div>
                <p class="mb-2 text-blue-300">Bejelentkezve: ${userProfile.name} (${userProfile.email})</p>
                <div id="enyStatus" class="mt-4 text-center"></div>
                <div id="enyDeviceTable" class="mt-4"></div>
            </div>
        `;
    }

    function getNewInspectionScreenHtml() {
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD formátum
        return `
            <div class="card max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold text-center mb-8">Új vizsgálat rögzítése</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8 border-b border-blue-800 pb-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-3">1. Sablon kiválasztása</h3>
                        <select id="templateSelectNewInspection" class="input-field" disabled><option>Sablonok betöltése...</option></select>
                        <p id="templateStatusNewInspection" class="text-sm text-yellow-400 mt-2 h-4"></p>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-3">2. Szakértő</h3>
                        <select id="expertSelectNewInspection" class="input-field" required>
                            <option value="" disabled selected>Válassz egy szakértőt...</option>
                            <option value="Nagy Imre">Nagy Imre</option>
                            <option value="Gerőly Iván">Gerőly Iván</option>
                            <option value="Szadlon Norbert">Szadlon Norbert</option>
                            <option value="Bagyinszki Lóránt">Bagyinszki Lóránt</option>
                        </select>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-3">3. Vizsgálat helye</h3>
                        <input type="text" id="inspectionLocationInput" placeholder="Pl. a partner telephelye" class="input-field">
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-3">4. Vizsgálat időpontja</h3>
                        <input type="date" id="inspectionDateInput" class="input-field" value="${today}">
                    </div>
                </div>

                <h3 class="text-lg font-semibold mb-3">5. Eszköz keresése</h3>
                <p class="mb-4 text-blue-300">Add meg a vizsgálandó eszköz gyári számát a meglévő adatok betöltéséhez.</p>
                <form id="searchDeviceForm" class="flex flex-col sm:flex-row items-center gap-4 mb-6">
                    <input type="text" id="serialNumberInput" placeholder="Gyári szám..." class="input-field flex-grow" required>
                    <button id="searchDeviceBySerialBtn" class="btn btn-primary w-full sm:w-auto">Eszköz keresése</button>
                </form>
                <div id="deviceSearchResult" class="bg-blue-900/50 p-6 rounded-lg min-h-[8rem]">
                    <p class="text-gray-400">A keresés eredménye itt fog megjelenni.</p>
                </div>

                <div class="mt-8 text-left"><button id="backToEjkMainBtn" class="btn btn-secondary">Vissza a főmenübe</button></div>
            </div>
        `;
    }
    
    </script>    

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- FORM PERSISTENCE LOGIC ---

        // 1. SAVE a list of field values to session storage
        const saveInspectionData = () => {
            const inspectionFieldIds = [
                'inspectionTypeNew', 
                'nextInspectionDateNew', 
                'nextLoadTestDateNew', 
                'inspectionResultNew',
                'foundFaultNew',
                'actionsTakenNew'
            ];
            inspectionFieldIds.forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    sessionStorage.setItem(`persist_manual_${id}`, field.value);
                }
            });
        };

        // 2. LOAD data from session storage into the form
        const loadInspectionData = () => {
            const inspectionFieldIds = [
                'inspectionTypeNew', 
                'nextInspectionDateNew', 
                'nextLoadTestDateNew', 
                'inspectionResultNew',
                'foundFaultNew',
                'actionsTakenNew'
            ];
            inspectionFieldIds.forEach(id => {
                const field = document.getElementById(id);
                const savedValue = sessionStorage.getItem(`persist_manual_${id}`);
                if (field && savedValue !== null) {
                    field.value = savedValue;
                    // Trigger a change event to ensure any dependent logic runs
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            // After loading, re-validate the form to enable the finish button if applicable
            updateNewInspectionFinishButtonState();
        };

        // 3. ATTACH listeners using event delegation
        document.body.addEventListener('click', (event) => {
            const button = event.target.closest('button');
            if (!button) return;

            // Save data when finishing an inspection
            if (button.id === 'finishNewInspectionBtn') {
                saveInspectionData();
            }

            // Load data when the new copy button is clicked
            if (button.id === 'copyPreviousInspectionDataBtn') {
                loadInspectionData();
            }
        });
    });
    </script>
</body>
</html>